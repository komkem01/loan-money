<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/Icon/image.png"/>
    <title>Login - Loan Tracker</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons for the eye icon -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- API Client -->
    <script src="/js/api.js"></script>
    <!-- Authentication utilities will be embedded below -->
    <style>
        /* Custom font from Google Fonts for a cuter look */
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');

        body {
            font-family: 'Nunito', sans-serif;
        }

        /* A subtle animation for the icon */
        .breathing-icon {
            animation: breathe 4s ease-in-out infinite;
        }

        @keyframes breathe {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }


    </style>
</head>

<body class="bg-emerald-50 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-sm p-8 space-y-6 bg-white/80 backdrop-blur-sm rounded-[2rem] shadow-xl">
        <div class="flex flex-col items-center space-y-3">
            <!-- Cute Piggy Bank Icon with Animation -->
            <div class="breathing-icon">
                <svg class="w-20 h-20 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c1.355 0 2.707-.158 4.007-.462M12 21c-1.355 0-2.707-.158-4.007-.462m0 0A9.005 9.005 0 0112 3c1.355 0 2.707.158 4.007.462m0 0A9.005 9.005 0 0012 3C10.645 3 9.293 3.158 8 3.462m0 0c-1.233 1.043-1.936 2.528-1.936 4.218 0 2.404 1.134 4.563 2.87 5.926m1.936-4.218c.288-.242.607-.453.95-.626m0 0a4.5 4.5 0 015.172 0m-.216 4.84c1.135-.333 2.16-.822 3.091-1.456m-8.1 0c.931.634 1.956 1.123 3.091 1.456" />
                </svg>
            </div>

            <h1 class="text-3xl font-extrabold text-center text-gray-800">Welcome Back!</h1>
            <p class="text-center text-gray-500">Let's manage your loans!</p>
        </div>

        <!-- Login Form -->
        <form id="loginForm" class="space-y-6">
            <!-- Username Input -->
            <div>
                <label for="username" class="text-sm font-semibold block mb-2 text-gray-600">Username</label>
                <input type="text" id="username" name="username"
                    class="w-full p-3 bg-gray-50/70 border border-gray-300 rounded-xl text-gray-800 focus:ring-emerald-500 focus:border-emerald-500 transition"
                    placeholder="username" required>
            </div>

            <!-- Password Input with Show/Hide Toggle -->
            <div>
                <label for="password" class="text-sm font-semibold block mb-2 text-gray-600">Password</label>
                <div class="relative">
                    <input type="password" id="password" name="password"
                        class="w-full p-3 pr-10 bg-gray-50/70 border border-gray-300 rounded-xl text-gray-800 focus:ring-emerald-500 focus:border-emerald-500 transition"
                        placeholder="••••••••" required>
                    <button type="button" id="togglePassword"
                        class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-emerald-500">
                        <i class="ph ph-eye text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Message Display Area -->
            <div id="message" class="text-sm text-center font-semibold"></div>

            <!-- Submit Button -->
            <button type="submit"
                class="w-full text-white bg-emerald-500 hover:bg-emerald-600 focus:ring-4 focus:ring-emerald-300 font-bold rounded-xl text-md px-5 py-3 text-center transition duration-300 shadow-lg hover:shadow-emerald-300/50">
                Sign In
            </button>
        </form>

        <p class="text-sm text-center text-gray-500">
            No account yet? <a href="/register.html" class="font-bold text-emerald-600 hover:underline">Create One!</a>
        </p>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 transform transition-all duration-300 scale-95">
            <div class="text-center">
                <!-- Error Icon -->
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <i class="ph-x-circle text-2xl text-red-600"></i>
                </div>
                
                <!-- Modal Title -->
                <h3 class="text-lg font-bold text-gray-900 mb-2" id="errorTitle">เกิดข้อผิดพลาด</h3>
                
                <!-- Modal Message -->
                <p class="text-sm text-gray-600 mb-6" id="errorMessage">
                    ข้อมูลเข้าสู่ระบบไม่ถูกต้อง
                </p>
                
                <!-- Modal Button -->
                <button id="errorOkButton" 
                    class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-xl transition duration-200">
                    ตกลง
                </button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 transform transition-all duration-300 scale-95">
            <div class="text-center">
                <!-- Success Icon -->
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                    <i class="ph-check-circle text-2xl text-green-600"></i>
                </div>
                
                <!-- Modal Title -->
                <h3 class="text-lg font-bold text-gray-900 mb-2" id="successTitle">สำเร็จ</h3>
                
                <!-- Modal Message -->
                <p class="text-sm text-gray-600 mb-6" id="successMessage">
                    เข้าสู่ระบบสำเร็จ
                </p>
                
                <!-- Modal Button -->
                <button id="successOkButton" 
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-xl transition duration-200">
                    ตกลง
                </button>
            </div>
        </div>
    </div>



    <script>
        // Authentication utilities for Loan Money App
        // API_BASE_URL is already defined in /js/api.js

        // Token Management
        const AuthManager = {
            // Save JWT token to localStorage with timestamp
            saveToken(token) {
                const tokenData = {
                    token: token,
                    timestamp: Date.now(),
                    expiresIn: 24 * 60 * 60 * 1000 // 24 hours in milliseconds
                };
                localStorage.setItem('loan_money_token', JSON.stringify(tokenData));
                console.log('Token saved with expiry:', new Date(Date.now() + tokenData.expiresIn));
            },

            // Get JWT token from localStorage and check if valid
            getToken() {
                try {
                    const tokenData = localStorage.getItem('loan_money_token');
                    if (!tokenData) return null;
                    
                    const parsed = JSON.parse(tokenData);
                    const now = Date.now();
                    const tokenAge = now - parsed.timestamp;
                    
                    // Check if token is expired (24 hours)
                    if (tokenAge > parsed.expiresIn) {
                        console.log('Token expired in getToken(), removing silently...');
                        this.removeToken();
                        // Don't redirect here - let checkTokenExpiry handle it with message
                        return null;
                    }
                    
                    return parsed.token;
                } catch (error) {
                    console.error('Error parsing token:', error);
                    this.removeToken();
                    return null;
                }
            },

            // Remove JWT token and all user data
            removeToken() {
                localStorage.removeItem('loan_money_token');
                localStorage.removeItem('loan_money_user');
                console.log('All tokens and user data cleared');
            },

            // Save user information
            saveUser(user) {
                localStorage.setItem('loan_money_user', JSON.stringify(user));
            },

            // Get user information
            getUser() {
                try {
                    const user = localStorage.getItem('loan_money_user');
                    return user ? JSON.parse(user) : null;
                } catch (error) {
                    console.error('Error parsing user data:', error);
                    return null;
                }
            },

            // Check if user is authenticated with valid token (without side effects)
            isAuthenticated() {
                try {
                    const tokenData = localStorage.getItem('loan_money_token');
                    if (!tokenData) return false;
                    
                    const parsed = JSON.parse(tokenData);
                    const user = localStorage.getItem('loan_money_user');
                    if (!user) return false;
                    
                    const now = Date.now();
                    const tokenAge = now - parsed.timestamp;
                    
                    // Just check validity without removing expired tokens
                    return tokenAge <= parsed.expiresIn;
                } catch (error) {
                    return false;
                }
            },

            // Redirect to login if not authenticated
            requireAuth() {
                if (!this.isAuthenticated()) {
                    this.redirectToLogin();
                    return false;
                }
                return true;
            },

            // Redirect to login page
            redirectToLogin() {
                window.location.href = '/index.html';
            },

            // Redirect to dashboard if already authenticated (but delay check)  
            redirectIfAuthenticated() {
                // Add delay to prevent immediate redirect on page load
                setTimeout(() => {
                    if (this.isAuthenticated()) {
                        console.log('User already authenticated, redirecting to dashboard...');
                        window.location.href = '/dashboard.html';
                    }
                }, 500); // 500ms delay
            },

            // Complete logout - clear all data and redirect
            logout() {
                this.removeToken();
                this.redirectToLogin();
            },

            // Get authorization headers for API calls
            getAuthHeaders() {
                const token = this.getToken();
                return token ? { 'Authorization': `Bearer ${token}` } : {};
            },

            // Check token expiry and auto-logout if needed
            checkTokenExpiry() {
                const tokenData = localStorage.getItem('loan_money_token');
                if (tokenData) {
                    try {
                        const parsed = JSON.parse(tokenData);
                        const now = Date.now();
                        const tokenAge = now - parsed.timestamp;
                        
                        // If token expires in less than 1 hour, show warning
                        const oneHour = 60 * 60 * 1000;
                        if (tokenAge > (parsed.expiresIn - oneHour)) {
                            console.warn('Token expires soon');
                        }
                        
                        // If expired, show message first then logout
                        if (tokenAge > parsed.expiresIn) {
                            console.log('Token expired, logging out...');
                            
                            // Show expiry message before redirect (only if not on login page)
                            if (window.location.pathname !== '/index.html' && window.location.pathname !== '/register.html') {
                                // Try to show message if showMessage function exists
                                if (typeof showMessage === 'function') {
                                    showMessage('⏰ เซสชันหมดอายุแล้ว กำลังนำท่านกลับสู่หน้าเข้าสู่ระบบ...', true);
                                }
                                
                                // Delay logout to let user see the message
                                setTimeout(() => {
                                    this.removeToken();
                                    this.redirectToLogin();
                                }, 30000);
                            } else {
                                // On login/register page, logout immediately
                                this.removeToken();
                            }
                        }
                    } catch (error) {
                        console.error('Error checking token expiry:', error);
                        this.removeToken();
                    }
                }
            }
        };

        // API Helper functions
        const ApiHelper = {
            // Make authenticated API request with token expiry checking
            async makeRequest(url, options = {}) {
                // Only check token expiry on protected pages, not login/register
                if (window.location.pathname !== '/index.html' && window.location.pathname !== '/register.html') {
                    AuthManager.checkTokenExpiry();
                }
                
                const defaultHeaders = {
                    'Content-Type': 'application/json',
                    ...AuthManager.getAuthHeaders()
                };

                const config = {
                    headers: defaultHeaders,
                    ...options
                };

                try {
                    const response = await fetch(`${API_BASE_URL}${url}`, config);
                    const data = await response.json();

                    // Handle unauthorized responses (expired token)
                    if (response.status === 401) {
                        console.log('Unauthorized - token expired, logging out...');
                        AuthManager.logout();
                        return { success: false, error: 'Session expired. Please login again.' };
                    }

                    return { success: response.ok, data, status: response.status };
                } catch (error) {
                    console.error('API Request failed:', error);
                    
                    // If on protected page and not authenticated, logout
                    if (window.location.pathname !== '/index.html' && window.location.pathname !== '/register.html') {
                        if (!AuthManager.isAuthenticated()) {
                            AuthManager.logout();
                        }
                    }
                    
                    return { 
                        success: false, 
                        error: 'เกิดข้อผิดพลาดในการเชื่อมต่อ กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต',
                        status: 0
                    };
                }
            },

            // User registration
            async register(userData) {
                return this.makeRequest('/api/v1/register', {
                    method: 'POST',
                    body: JSON.stringify(userData)
                });
            },

            // User login
            async login(credentials) {
                return this.makeRequest('/api/v1/login', {
                    method: 'POST',
                    body: JSON.stringify(credentials)
                });
            },

            // Get user profile
            async getProfile() {
                return this.makeRequest('/api/v1/profile', {
                    method: 'GET'
                });
            },

            // Update user profile
            async updateProfile(profileData) {
                return this.makeRequest('/api/v1/profile', {
                    method: 'PATCH',
                    body: JSON.stringify(profileData)
                });
            },

            // Change password
            async changePassword(passwordData) {
                return this.makeRequest('/api/v1/change-password', {
                    method: 'PATCH',
                    body: JSON.stringify(passwordData)
                });
            },

            // Logout (client-side only for now)
            logout() {
                AuthManager.removeToken();
                window.location.href = '/index.html';
            }
        };

        // Form validation utilities
        const ValidationHelper = {
            // Validate username
            validateUsername(username) {
                if (!username || username.length < 3) {
                    return 'ชื่อผู้ใช้ต้องมีอย่างน้อย 3 ตัวอักษร';
                }
                
                const usernameRegex = /^[a-zA-Z0-9_]+$/;
                if (!usernameRegex.test(username)) {
                    return 'ชื่อผู้ใช้สามารถใช้ได้เฉพาะตัวอักษร ตัวเลข และ _';
                }
                
                return null;
            },

            // Validate password
            validatePassword(password) {
                if (!password || password.length < 6) {
                    return 'รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร';
                }
                return null;
            },

            // Validate full name
            validateFullName(fullName) {
                if (!fullName || fullName.trim().length < 2) {
                    return 'ชื่อเต็มต้องมีอย่างน้อย 2 ตัวอักษร';
                }
                return null;
            },

            // Validate password confirmation
            validatePasswordConfirmation(password, confirmPassword) {
                if (password !== confirmPassword) {
                    return 'รหัสผ่านและการยืนยันรหัสผ่านไม่ตรงกัน';
                }
                return null;
            }
        };

        // UI Helper functions
        const UIHelper = {
            // Show loading state on button
            setButtonLoading(button, isLoading, loadingText = 'กำลังดำเนินการ...') {
                if (isLoading) {
                    button.dataset.originalText = button.textContent;
                    button.textContent = loadingText;
                    button.disabled = true;
                } else {
                    button.textContent = button.dataset.originalText || button.textContent;
                    button.disabled = false;
                }
            },

            // Show error message
            showError(message, duration = 5000) {
                console.error('Error:', message);
            },

            // Show success message
            showSuccess(message, duration = 3000) {
                console.log('Success:', message);
            }
        };

        // === Login Page Specific Code ===
        let loginForm, messageDiv, passwordInput, togglePasswordButton, toggleIcon;

        // Initialize elements when DOM is ready
        function initializeElements() {
            loginForm = document.getElementById('loginForm');
            messageDiv = document.getElementById('message');
            passwordInput = document.getElementById('password');
            togglePasswordButton = document.getElementById('togglePassword');
            toggleIcon = togglePasswordButton ? togglePasswordButton.querySelector('i') : null;
            
            console.log('Elements initialized:', {
                loginForm: !!loginForm,
                messageDiv: !!messageDiv,
                passwordInput: !!passwordInput,
                togglePasswordButton: !!togglePasswordButton,
                toggleIcon: !!toggleIcon
            });
        }

        // --- Show/Hide Password Logic ---
        function setupPasswordToggle() {
            if (togglePasswordButton && passwordInput && toggleIcon) {
                console.log('Setting up password toggle');
                togglePasswordButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Password toggle clicked');
                    const isPassword = passwordInput.type === 'password';
                    passwordInput.type = isPassword ? 'text' : 'password';
                    toggleIcon.classList.toggle('ph-eye');
                    toggleIcon.classList.toggle('ph-eye-slash');
                });
            } else {
                console.error('Password toggle elements not found:', {
                    togglePasswordButton: !!togglePasswordButton,
                    passwordInput: !!passwordInput,
                    toggleIcon: !!toggleIcon
                });
            }
        }

        // --- Modal Functions ---
        function showErrorModal(title, message, onConfirm = null) {
            const modal = document.getElementById('errorModal');
            const titleElement = document.getElementById('errorTitle');
            const messageElement = document.getElementById('errorMessage');
            const okButton = document.getElementById('errorOkButton');
            
            titleElement.textContent = title;
            messageElement.textContent = message;
            
            // Show modal with animation
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('.bg-white').classList.add('scale-100');
                modal.querySelector('.bg-white').classList.remove('scale-95');
            }, 10);
            
            // Handle OK button click
            const handleOkClick = () => {
                // Hide modal with animation
                modal.querySelector('.bg-white').classList.add('scale-95');
                modal.querySelector('.bg-white').classList.remove('scale-100');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
                
                // Execute callback if provided
                if (onConfirm) {
                    onConfirm();
                }
                
                // Remove event listener
                okButton.removeEventListener('click', handleOkClick);
            };
            
            okButton.addEventListener('click', handleOkClick);
        }
        
        function showSuccessModal(title, message, onConfirm = null) {
            const modal = document.getElementById('successModal');
            const titleElement = document.getElementById('successTitle');
            const messageElement = document.getElementById('successMessage');
            const okButton = document.getElementById('successOkButton');
            
            titleElement.textContent = title;
            messageElement.textContent = message;
            
            // Show modal with animation
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('.bg-white').classList.add('scale-100');
                modal.querySelector('.bg-white').classList.remove('scale-95');
            }, 10);
            
            // Handle OK button click
            const handleOkClick = () => {
                // Hide modal with animation
                modal.querySelector('.bg-white').classList.add('scale-95');
                modal.querySelector('.bg-white').classList.remove('scale-100');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
                
                // Execute callback if provided
                if (onConfirm) {
                    onConfirm();
                }
                
                // Remove event listener
                okButton.removeEventListener('click', handleOkClick);
            };
            
            okButton.addEventListener('click', handleOkClick);
        }

        // --- Message Display Functions (Legacy - for compatibility) ---
        function showMessage(message, isError = false) {
            if (isError) {
                showErrorModal('เกิดข้อผิดพลาด', message);
            } else {
                showSuccessModal('สำเร็จ', message);
            }
        }

        // --- Form Submission Logic ---
        function setupFormSubmission() {
            if (loginForm) {
                console.log('Setting up form submission');
                loginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            event.stopPropagation();
            console.log('Form submitted!');
            
            if (messageDiv) messageDiv.textContent = '';

            const username = document.getElementById('username').value.trim();
            const password = passwordInput ? passwordInput.value : '';

            console.log('Attempting to log in with:', { username, passwordLength: password.length });

            // Validation using ValidationHelper
            const usernameError = ValidationHelper.validateUsername(username);
            if (usernameError) {
                showErrorModal('ข้อมูลไม่ถูกต้อง', usernameError);
                return;
            }

            const passwordError = ValidationHelper.validatePassword(password);
            if (passwordError) {
                showErrorModal('ข้อมูลไม่ถูกต้อง', passwordError);
                return;
            }

            // Disable form during submission
            const submitButton = loginForm.querySelector('button[type="submit"]');
            UIHelper.setButtonLoading(submitButton, true, 'กำลังเข้าสู่ระบบ...');

            try {
                // Call backend API using ApiHelper
                const result = await ApiHelper.login({ username, password });

                if (result && result.success && result.data) {
                    // Login successful
                    console.log('Login successful:', result.data);
                    
                    // Save token and user info using AuthManager
                    AuthManager.saveToken(result.data.token);
                    AuthManager.saveUser(result.data.user);
                    
                    // Show success modal and redirect after user confirms
                    showSuccessModal(
                        'เข้าสู่ระบบสำเร็จ!', 
                        'ยินดีต้อนรับเข้าสู่ระบบ กำลังนำท่านไปยังหน้าหลัก...', 
                        () => {
                            window.location.href = '/dashboard.html';
                        }
                    );
                    
                } else {
                    // Login failed
                    console.error('Login failed:', result);
                    let errorTitle = 'เข้าสู่ระบบไม่สำเร็จ';
                    let errorMessage = 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง กรุณาตรวจสอบและลองใหม่อีกครั้ง';
                    
                    // Check for specific error messages from server
                    if (result?.data?.error) {
                        const serverError = result.data.error.toLowerCase();
                        if (serverError.includes('username') || serverError.includes('user not found')) {
                            errorTitle = 'ไม่พบชื่อผู้ใช้';
                            errorMessage = 'ไม่พบชื่อผู้ใช้นี้ในระบบ กรุณาตรวจสอบการสะกดหรือสมัครสมาชิกใหม่';
                        } else if (serverError.includes('password') || serverError.includes('invalid password')) {
                            errorTitle = 'รหัสผ่านไม่ถูกต้อง';
                            errorMessage = 'รหัสผ่านที่ป่อนไม่ถูกต้อง กรุณากรอกรหัสผ่านให้ถูกต้อง';
                        } else if (serverError.includes('invalid credentials')) {
                            errorTitle = 'ข้อมูลไม่ถูกต้อง';
                            errorMessage = 'ข้อมูลเข้าสู่ระบบไม่ถูกต้อง กรุณาตรวจสอบชื่อผู้ใช้และรหัสผ่านอีกครั้ง';
                        }
                    }
                    
                    showErrorModal(errorTitle, errorMessage);
                }

            } catch (error) {
                console.error('Login error:', error);
                showErrorModal(
                    'เกิดข้อผิดพลาด', 
                    'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้ กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ตและลองใหม่อีกครั้ง'
                );
            } finally {
                // Re-enable form
                UIHelper.setButtonLoading(submitButton, false);
            }
                });
                
                // Also add click handler to submit button as backup
                const submitButton = loginForm.querySelector('button[type="submit"]');
                if (submitButton) {
                    console.log('Adding backup click handler to submit button');
                    submitButton.addEventListener('click', (e) => {
                        console.log('Submit button clicked directly');
                        // Let the form submission handler take over
                    });
                }
            } else {
                console.error('Login form not found');
            }
        }

        // Remove all testing functions - they interfere with normal usage

        // Setup modal backdrop click handlers
        function setupModalHandlers() {
            // Error modal backdrop click
            document.getElementById('errorModal').addEventListener('click', (e) => {
                if (e.target.id === 'errorModal') {
                    document.getElementById('errorOkButton').click();
                }
            });
            
            // Success modal backdrop click
            document.getElementById('successModal').addEventListener('click', (e) => {
                if (e.target.id === 'successModal') {
                    document.getElementById('successOkButton').click();
                }
            });
        }

        // Initialize everything when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM Content Loaded');
            
            initializeElements();
            setupPasswordToggle();
            setupFormSubmission();
            setupModalHandlers();
            
            // Check auth status when page loads
            AuthManager.redirectIfAuthenticated();
        });
    </script>

</body>

</html>