<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/Icon/image.png"/>
    <title>Create Account - Loan Tracker</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons for the eye icon -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Authentication utilities will be embedded below -->
    <style>
        /* Custom font from Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');

        body {
            font-family: 'Nunito', sans-serif;
        }


    </style>
</head>

<body class="bg-emerald-50 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-sm p-8 space-y-6 bg-white/80 backdrop-blur-sm rounded-[2rem] shadow-xl">
        <div class="flex flex-col items-center space-y-3">
            <!-- Cute Icon -->
            <svg class="w-20 h-20 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.962a3.75 3.75 0 015.962 0L14.25 6h5.25a3 3 0 013 3v5.25M12 21V3.75" />
            </svg>

            <h1 class="text-3xl font-extrabold text-center text-gray-800">Create Account</h1>
            <p class="text-center text-gray-500">Join us and start tracking!</p>
        </div>

        <!-- Registration Form -->
        <form id="registerForm" class="space-y-4">
            <!-- Full Name Input -->
            <div>
                <label for="fullName" class="text-sm font-semibold block mb-2 text-gray-600">Full Name</label>
                <input type="text" id="fullName" name="fullName"
                    class="w-full p-3 bg-gray-50/70 border border-gray-300 rounded-xl text-gray-800 focus:ring-emerald-500 focus:border-emerald-500 transition"
                    placeholder="Your Name" required>
            </div>

            <!-- Username Input -->
            <div>
                <label for="username" class="text-sm font-semibold block mb-2 text-gray-600">Username</label>
                <input type="text" id="username" name="username"
                    class="w-full p-3 bg-gray-50/70 border border-gray-300 rounded-xl text-gray-800 focus:ring-emerald-500 focus:border-emerald-500 transition"
                    placeholder="username" required>
            </div>

            <!-- Password Input -->
            <div>
                <label for="password" class="text-sm font-semibold block mb-2 text-gray-600">Password</label>
                <div class="relative">
                    <input type="password" id="password" name="password"
                        class="w-full p-3 pr-10 bg-gray-50/70 border border-gray-300 rounded-xl text-gray-800 focus:ring-emerald-500 focus:border-emerald-500 transition"
                        placeholder="••••••••" required>
                    <button type="button" id="togglePassword"
                        class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-emerald-500">
                        <i class="ph ph-eye text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Confirm Password Input -->
            <div>
                <label for="confirmPassword" class="text-sm font-semibold block mb-2 text-gray-600">Confirm
                    Password</label>
                <input type="password" id="confirmPassword" name="confirmPassword"
                    class="w-full p-3 bg-gray-50/70 border border-gray-300 rounded-xl text-gray-800 focus:ring-emerald-500 focus:border-emerald-500 transition"
                    placeholder="••••••••" required>
            </div>

            <!-- Message Display Area -->
            <div id="message" class="text-sm text-center font-semibold"></div>

            <!-- Submit Button -->
            <button type="submit"
                class="w-full text-white bg-emerald-500 hover:bg-emerald-600 focus:ring-4 focus:ring-emerald-300 font-bold rounded-xl text-md px-5 py-3 text-center transition duration-300 shadow-lg hover:shadow-emerald-300/50">
                Sign Up
            </button>
        </form>

        <p class="text-sm text-center text-gray-500">
            Already have an account? <a href="./index.html" class="font-bold text-emerald-600 hover:underline">Sign
                In</a>
        </p>
    </div>



    <script>
        // Authentication utilities for Loan Money App
        const API_BASE_URL = 'http://localhost:3001';

        // Token Management
        const AuthManager = {
            // Save JWT token to localStorage with timestamp
            saveToken(token) {
                const tokenData = {
                    token: token,
                    timestamp: Date.now(),
                    expiresIn: 24 * 60 * 60 * 1000 // 24 hours in milliseconds
                };
                localStorage.setItem('loan_money_token', JSON.stringify(tokenData));
                console.log('Token saved with expiry:', new Date(Date.now() + tokenData.expiresIn));
            },

            // Get JWT token from localStorage and check if valid
            getToken() {
                try {
                    const tokenData = localStorage.getItem('loan_money_token');
                    if (!tokenData) return null;
                    
                    const parsed = JSON.parse(tokenData);
                    const now = Date.now();
                    const tokenAge = now - parsed.timestamp;
                    
                    // Check if token is expired (24 hours)
                    if (tokenAge > parsed.expiresIn) {
                        console.log('Token expired, removing...');
                        this.removeToken();
                        this.redirectToLogin();
                        return null;
                    }
                    
                    return parsed.token;
                } catch (error) {
                    console.error('Error parsing token:', error);
                    this.removeToken();
                    return null;
                }
            },

            // Remove JWT token and all user data
            removeToken() {
                localStorage.removeItem('loan_money_token');
                localStorage.removeItem('loan_money_user');
                console.log('All tokens and user data cleared');
            },

            // Save user information
            saveUser(user) {
                localStorage.setItem('loan_money_user', JSON.stringify(user));
            },

            // Get user information
            getUser() {
                try {
                    const user = localStorage.getItem('loan_money_user');
                    return user ? JSON.parse(user) : null;
                } catch (error) {
                    console.error('Error parsing user data:', error);
                    return null;
                }
            },

            // Check if user is authenticated with valid token (without side effects)
            isAuthenticated() {
                try {
                    const tokenData = localStorage.getItem('loan_money_token');
                    if (!tokenData) return false;
                    
                    const parsed = JSON.parse(tokenData);
                    const user = localStorage.getItem('loan_money_user');
                    if (!user) return false;
                    
                    const now = Date.now();
                    const tokenAge = now - parsed.timestamp;
                    
                    // Just check validity without removing expired tokens
                    return tokenAge <= parsed.expiresIn;
                } catch (error) {
                    return false;
                }
            },

            // Redirect to login if not authenticated
            requireAuth() {
                if (!this.isAuthenticated()) {
                    this.redirectToLogin();
                    return false;
                }
                return true;
            },

            // Redirect to login page
            redirectToLogin() {
                window.location.href = '/index.html';
            },



            // Complete logout - clear all data and redirect
            logout() {
                this.removeToken();
                this.redirectToLogin();
            },

            // Get authorization headers for API calls
            getAuthHeaders() {
                const token = this.getToken();
                return token ? { 'Authorization': `Bearer ${token}` } : {};
            },

            // Check token expiry and auto-logout if needed
            checkTokenExpiry() {
                const tokenData = localStorage.getItem('loan_money_token');
                if (tokenData) {
                    try {
                        const parsed = JSON.parse(tokenData);
                        const now = Date.now();
                        const tokenAge = now - parsed.timestamp;
                        
                        // If token expires in less than 1 hour, show warning
                        const oneHour = 60 * 60 * 1000;
                        if (tokenAge > (parsed.expiresIn - oneHour)) {
                            console.warn('Token expires soon');
                        }
                        
                        // If expired, logout immediately (no delay to prevent loops)
                        if (tokenAge > parsed.expiresIn) {
                            console.log('Token expired, removing token...');
                            this.removeToken();
                            // Don't redirect on login/register page - user is already here
                            if (window.location.pathname !== '/index.html' && window.location.pathname !== '/register.html') {
                                this.redirectToLogin();
                            }
                        }
                    } catch (error) {
                        console.error('Error checking token expiry:', error);
                        this.removeToken();
                    }
                }
            }
        };

        // API Helper functions
        const ApiHelper = {
            // Make authenticated API request with token expiry checking
            async makeRequest(url, options = {}) {
                // Only check token expiry on protected pages, not login/register
                if (window.location.pathname !== '/index.html' && window.location.pathname !== '/register.html') {
                    AuthManager.checkTokenExpiry();
                }
                
                const defaultHeaders = {
                    'Content-Type': 'application/json',
                    ...AuthManager.getAuthHeaders()
                };

                const config = {
                    headers: defaultHeaders,
                    ...options
                };

                try {
                    const response = await fetch(`${API_BASE_URL}${url}`, config);
                    const data = await response.json();

                    // Handle unauthorized responses (expired token)
                    if (response.status === 401) {
                        console.log('Unauthorized - token expired, logging out...');
                        AuthManager.logout();
                        return { success: false, error: 'Session expired. Please login again.' };
                    }

                    return { success: response.ok, data, status: response.status };
                } catch (error) {
                    console.error('API Request failed:', error);
                    
                    // If on protected page and not authenticated, logout
                    if (window.location.pathname !== '/index.html' && window.location.pathname !== '/register.html') {
                        if (!AuthManager.isAuthenticated()) {
                            AuthManager.logout();
                        }
                    }
                    
                    return { 
                        success: false, 
                        error: 'เกิดข้อผิดพลาดในการเชื่อมต่อ กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต',
                        status: 0
                    };
                }
            },

            // User registration
            async register(userData) {
                return this.makeRequest('/api/v1/register', {
                    method: 'POST',
                    body: JSON.stringify(userData)
                });
            },

            // User login
            async login(credentials) {
                return this.makeRequest('/api/v1/login', {
                    method: 'POST',
                    body: JSON.stringify(credentials)
                });
            },

            // Get user profile
            async getProfile() {
                return this.makeRequest('/api/v1/profile', {
                    method: 'GET'
                });
            },

            // Logout (client-side only for now)
            logout() {
                AuthManager.removeToken();
                window.location.href = '/index.html';
            }
        };

        // Form validation utilities
        const ValidationHelper = {
            // Validate username
            validateUsername(username) {
                if (!username || username.length < 3) {
                    return 'ชื่อผู้ใช้ต้องมีอย่างน้อย 3 ตัวอักษร';
                }
                
                const usernameRegex = /^[a-zA-Z0-9_]+$/;
                if (!usernameRegex.test(username)) {
                    return 'ชื่อผู้ใช้สามารถใช้ได้เฉพาะตัวอักษร ตัวเลข และ _';
                }
                
                return null;
            },

            // Validate password
            validatePassword(password) {
                if (!password || password.length < 6) {
                    return 'รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร';
                }
                return null;
            },

            // Validate full name
            validateFullName(fullName) {
                if (!fullName || fullName.trim().length < 2) {
                    return 'ชื่อเต็มต้องมีอย่างน้อย 2 ตัวอักษร';
                }
                return null;
            },

            // Validate password confirmation
            validatePasswordConfirmation(password, confirmPassword) {
                if (password !== confirmPassword) {
                    return 'รหัสผ่านและการยืนยันรหัสผ่านไม่ตรงกัน';
                }
                return null;
            }
        };

        // UI Helper functions
        const UIHelper = {
            // Show loading state on button
            setButtonLoading(button, isLoading, loadingText = 'กำลังดำเนินการ...') {
                if (isLoading) {
                    button.dataset.originalText = button.textContent;
                    button.textContent = loadingText;
                    button.disabled = true;
                } else {
                    button.textContent = button.dataset.originalText || button.textContent;
                    button.disabled = false;
                }
            },

            // Show error message
            showError(message, duration = 5000) {
                console.error('Error:', message);
            },

            // Show success message
            showSuccess(message, duration = 3000) {
                console.log('Success:', message);
            }
        };

        // === Register Page Specific Code ===
        let registerForm, messageDiv, passwordInput, confirmPasswordInput, togglePasswordButton, toggleIcon;

        // Initialize elements when DOM is ready
        function initializeElements() {
            registerForm = document.getElementById('registerForm');
            messageDiv = document.getElementById('message');
            passwordInput = document.getElementById('password');
            confirmPasswordInput = document.getElementById('confirmPassword');
            togglePasswordButton = document.getElementById('togglePassword');
            toggleIcon = togglePasswordButton ? togglePasswordButton.querySelector('i') : null;
            
            console.log('Elements initialized:', {
                registerForm: !!registerForm,
                messageDiv: !!messageDiv,
                passwordInput: !!passwordInput,
                confirmPasswordInput: !!confirmPasswordInput,
                togglePasswordButton: !!togglePasswordButton,
                toggleIcon: !!toggleIcon
            });
        }

        // --- Show/Hide Password Logic ---
        function setupPasswordToggle() {
            if (togglePasswordButton && passwordInput && toggleIcon) {
                console.log('Setting up password toggle');
                togglePasswordButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Password toggle clicked');
                    const isPassword = passwordInput.type === 'password';
                    passwordInput.type = isPassword ? 'text' : 'password';
                    toggleIcon.classList.toggle('ph-eye');
                    toggleIcon.classList.toggle('ph-eye-slash');
                });
            } else {
                console.error('Password toggle elements not found:', {
                    togglePasswordButton: !!togglePasswordButton,
                    passwordInput: !!passwordInput,
                    toggleIcon: !!toggleIcon
                });
            }
        }

        // --- Message Display Functions ---
        function showMessage(message, isError = false) {
            const messageDiv = document.getElementById('message');
            if (messageDiv) {
                messageDiv.textContent = message;
                messageDiv.className = isError 
                    ? 'text-sm text-center font-semibold text-red-600' 
                    : 'text-sm text-center font-semibold text-green-600';
                
                // Clear message after 5 seconds
                setTimeout(() => {
                    messageDiv.textContent = '';
                    messageDiv.className = 'text-sm text-center font-semibold';
                }, 5000);
            }
        }

        // --- Form Submission Logic ---
        function setupFormSubmission() {
            if (registerForm) {
                console.log('Setting up form submission');
                registerForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    console.log('Form submitted!');
                    
                    if (messageDiv) messageDiv.textContent = '';

                    const fullName = document.getElementById('fullName').value.trim();
                    const username = document.getElementById('username').value.trim();
                    const password = passwordInput ? passwordInput.value : '';
                    const confirmPassword = confirmPasswordInput ? confirmPasswordInput.value : '';

                    console.log('Attempting to register with:', { fullName, username, passwordLength: password.length });

                    // --- Enhanced Validation using ValidationHelper ---
                    if (!fullName || !username || !password || !confirmPassword) {
                        showMessage('กรุณากรอกข้อมูลให้ครบทุกช่อง', true);
                        return;
                    }

                    const fullNameError = ValidationHelper.validateFullName(fullName);
                    if (fullNameError) {
                        showMessage(fullNameError, true);
                        return;
                    }

                    const usernameError = ValidationHelper.validateUsername(username);
                    if (usernameError) {
                        showMessage(usernameError, true);
                        return;
                    }

                    const passwordError = ValidationHelper.validatePassword(password);
                    if (passwordError) {
                        showMessage(passwordError, true);
                        return;
                    }

                    const confirmPasswordError = ValidationHelper.validatePasswordConfirmation(password, confirmPassword);
                    if (confirmPasswordError) {
                        showMessage(confirmPasswordError, true);
                        return;
                    }

                    // Disable form during submission
                    const submitButton = registerForm.querySelector('button[type="submit"]');
                    UIHelper.setButtonLoading(submitButton, true, 'กำลังสมัครสมาชิก...');

                    try {
                        // Call backend API using ApiHelper
                        const result = await ApiHelper.register({
                            username: username,
                            password: password,
                            fullName: fullName
                        });

                        if (result && result.success) {
                            // Registration successful
                            console.log('Registration successful:', result.data);
                            
                            // Show success message and redirect
                            showMessage('สมัครสมาชิกสำเร็จ! กำลังนำท่านไปยังหน้าล็อกอิน...', false);
                            
                            setTimeout(() => {
                                window.location.href = './index.html';
                            }, 2000);
                            
                        } else {
                            // Registration failed
                            console.error('Registration failed:', result);
                            
                            // แสดงข้อความ error ที่ได้จาก backend โดยตรง
                            let errorMessage = result?.data?.error || result?.error || '❌ เกิดข้อผิดพลาดในการสมัครสมาชิก กรุณาลองใหม่อีกครั้ง';
                            showMessage(errorMessage, true);
                        }

                    } catch (error) {
                        console.error('Registration error:', error);
                        showMessage('เกิดข้อผิดพลาดในการเชื่อมต่อ กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต', true);
                    } finally {
                        // Re-enable form
                        UIHelper.setButtonLoading(submitButton, false);
                    }
                });
                
                // Also add click handler to submit button as backup
                const submitButton = registerForm.querySelector('button[type="submit"]');
                if (submitButton) {
                    console.log('Adding backup click handler to submit button');
                    submitButton.addEventListener('click', (e) => {
                        console.log('Submit button clicked directly');
                        // Let the form submission handler take over
                    });
                }
            } else {
                console.error('Register form not found');
            }
        }

        // Initialize everything when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM Content Loaded');
            
            initializeElements();
            setupPasswordToggle();
            setupFormSubmission();
            
            // ไม่ต้องตรวจสอบ auth ในหน้า register - ให้ user สมัครสมาชิกได้เสมอ
        });
    </script>

</body>

</html>